console.log('scraper.js loaded');

function wrap(arg) {
	try {
		return arg()
	} catch (err) {
		return null;
	}
}

const fbidRegex = /.+fbid=(\d+).+/;
const fbidFallbackRegex = /\/.+\/photos\/.+\/(\d+).+/

class Post {
	text;
	date;
	likes;
	photoFbId;
	photoDescription;
	sharedFrom;
	sharedText;

	constructor(node) {
		let photoUrl = wrap(() => node.querySelector("div>a[href]:has(img)").getAttribute("href"));
		let photoFbId = wrap(() => photoUrl.match(fbidRegex)[1]);
		if (photoFbId == null) {
			photoFbId = wrap(() => photoUrl.match(fbidFallbackRegex)[1]);
		}

		this.text = wrap(() => node.querySelector("article header+div").textContent);
		this.date = wrap(() => node.querySelector("footer div abbr").textContent);
		this.likes = wrap(() => node.querySelector("div>span>a[aria-label]").getAttribute("aria-label"));
		this.photoFbId = photoFbId;
		this.photoDescription = wrap(() => node.querySelector("a>img[alt]").getAttribute("alt"));
		this.sharedFrom = wrap(() => node.querySelector("article article header header strong").textContent);
		this.sharedText = wrap(() => node.querySelector("article article header+div").textContent);
	}
}


if (document.location.href.includes("mbasic")) {
	const DB_KEY = "satuk_scraper";

	let db = localStorage.getItem(DB_KEY);

	if (db) {
		db = JSON.parse(db);
	} else {
		db = [];
	}

	document.body.style.border = "5px solid red";

	let posts = document.querySelectorAll("section>article");

	for (const post of posts) {
		db.push(new Post(post))
	}

	console.log("db size " + db.length);

	localStorage.setItem(DB_KEY, JSON.stringify(db));


	const nextPage = wrap(() => document.querySelector("section+div>a").getAttribute("href"));


	document.addEventListener('keydown', function (event) {
		if (event.keyCode == 39) { // right arrow
			if (!nextPage) {
				alert("No next page button");
			} else {
				window.location.href = nextPage;
			}
		}
	});
}

const SATUK_SCRAPER_ID_KEY = "satuk_scraper_id";
const SCRAPING_ENABLED_KEY = "scraping_enabled";

let ids = ["1611732125531795", "1610858522285822", "1610754522296222", "1610455452326129", "1551254228253802", "1609689849069356", "1609678965737111", "1609672859071055", "1609666455738362", "1609382515766756", "1609000222471652", "1608980489140292", "1608942145810793", "1608405249197816", "1549198375126054", "1548302238549001", "150301018917369", "1606648669373474", "1606563686048639", "1606153669422974", "1606152959423045", "1605561589482182", "1605557639482577", "1605521296152878", "1605517082819966", "1605470509491290", "1605436129494728", "1604725419565799", "1604349896270018", "1603945856310422", "1603776852993989", "1603752739663067", "1603374563034218", "1602554716449536", "1601847696520238", "1601509326554075", "1601171279921213", "1601073259931015", "1600117116693296", "1599642766740731", "1599142270124114", "1599019566803051", "1597910886913919", "1597748003596874", "1595107023860972", "1595078573863817", "1595049677200040", "1594777350560606", "1594743407230667", "1594529667252041", "1594039147301093", "1594034707301537", "1592901884081486", "1592888854082789", "1592888644082810", "1592641297440878", "1591735640864777", "1591574210880920", "1591451204226554", "1591025577602450", "1591024864269188", "1590767267628281", "1590698224301852", "1588555971182744", "1588109661227375", "1587546507950357", "850954498405205", "1586333851404956", "1586332791405062", "1586279598077048", "1586149181423423", "1585888344782840", "1585883198116688", "1585777328127275", "1584782218226786", "1899515247042504", "1584290538275954", "1584191468285861", "1584168341621507", "1583865818318426", "1583739168331091", "1428378647282943", "1583321268372881", "1583310188373989", "1583272561711085", "1583215028383505", "1582584088446599", "1582421368462871", "1582404171797924", "1582227608482247", "1582190401819301", "1582131388491869", "1580984161939925", "1580828725288802", "1580243395347335", "1579071845464490", "1578397408865267", "1578296232208718", "1578271358877872", "1577429902295351", "434190306982965", "1576433395728335", "1576381505733524", "1575436519161356", "1575394442498897", "1575390755832599", "1575383359166672", "1932279733707455", "1575117169193291", "10155169665819302", "1574106539294354", "1573854452652896", "1573429299362078", "1572939242744417", "1572458009459207", "1572445619460446", "1570519829653025", "1570183889686619", "1569606196411055", "1569449169760091", "1569186939786314", "1568815823156759", "1568747983163543", "1568631579841850", "1568630109841997", "1568503496521325", "1568232359881772", "1567786553259686", "1567285323309809", "1566822830022725", "1566588036712871", "1566314873406854", "1565952616776413", "889366894561063", "1565490720155936", "1565295070175501", "1564674186904256", "1564453506926324", "1564435190261489", "1564416920263316", "1564409670264041", "1564399496931725", "1564354333602908", "1564348946936780", "1564007453637596", "1563958553642486", "1563643427007332", "1563648657006809", "1563609073677434", "1562808653757476", "1562793350425673", "1562784493759892", "1562739333764408", "1562661490438859", "1562521687119506", "1562460653792276", "1562411510463857", "1562348437136831", "1561804687191206", "1561699263868415", "1561543063884035", "1561395977232077", "1560497457321929", "1560423980662610", "1560129120692096", "1560086994029642", "1560051027366572", "2229826303909958", "1559781107393564", "1559692197402455", "1559117647459910", "1558969244141417", "1558821424156199", "1558817570823251", "1558716007500074", "1558708354167506", "1557602747611400", "2046891812213566", "1555358957835779", "1555244871180521", "1554647254573616", "1836205713357084", "1554358651269143", "1554234847948190", "1554156424622699", "1554155134622828", "1552645484773793", "1552641881440820", "1551486498223025", "1550814718290203", "1550645801640428", "1549964271708581", "1549504465087895", "1549481468423528", "1549477151757293", "1548955101809498", "1337457319713911", "1548113681893640", "1548026168569058", "1548021245236217", "1547013418670333", "1546765782028430", "1546763268695348", "1546134865424855", "1546062712098737", "1546010675437274", "1545980732106935", "1545912678780407", "1545899235448418", "1545384925499849", "1545332438838431", "1545272898844385", "1545212305517111", "1545144072190601", "1545080612196947", "1544900178881657", "1544272168944458", "1544177262287282", "1543942382310770", "1543431535695188", "1542630485775293", "1542463655791976", "509450949395299", "1541301965908145", "1540737472631261", "1540715582633450", "1539692999402375", "1539284946109847", "1538768222828186", "1538728866165455", "1538463152858693", "1538440152860993", "1538434099528265", "1538384509533224", "1538336319538043", "1538300899541585", "1537908786247463", "1537840899587585", "1537665969605078", "1537659939605681", "1537659489605726", "1537658406272501", "1537001449671530", "1536663466371995", "1536479953057013", "1536461346392207", "1535419373163071", "1535054033199605", "1533905209981154", "1532940520077623", "1532900970081578", "1532187616819580", "1530689206969421", "1530423926995949", "1530423593662649", "1530423186996023", "1530341123670896", "1530340290337646", "1530339040337771", "1530338923671116", "1530338803671128", "1530338633671145", "1530334813671527", "1530330263671982", "1530329033672105", "1529739200397755", "1528308463874162", "1527638407274501", "1526355780736097", "1526355160736159", "1525425620829113", "1524806327557709", "1523947384310270", "1523693831002292", "1523665514338457", "1523635214341487", "1522827641088911", "1522096294495379", "1522077491163926", "1391174710974168", "1521931887845153", "1522024847835857", "1521931617845180", "1521929211178754", "1521916417846700", "1520904204614588", "1520247034680305", "1520246754680333", "1520139298024412", "1520112758027066", "1520105008027841", "1519141174790891", "1519134668124875", "1519018134803195", "1519017648136577", "1519017264803282", "1519016848136657", "1519015698136772", "1518844598153882", "1518035254901483", "1517322421639433", "809634972463071", "1516818985023110", "1516321671739508", "1516092728429069", "1515201961851479", "859182840816585", "1514967815208227", "1514592965245712", "1514555381916137", "1514157291955946", "335336823570482", "1512225748815767", "1512204815484527", "1511304348907907", "463360910696815", "1511102472261428", "1510165895688419", "1509420942429581", "1508289955876013", "1508222419216100", "379436292429305", "1505260522845623", "1505249962846679", "1505243936180615", "1504458102925865", "1504195652952110", "1503425249695817", "1503423259696016", "1503381529700189", "1503055983066077", "1500242550014087", "458497874516452", "1499014866803522", "1498106726894336", "1498007613570914", "1497790613592614", "1497527676952241", "1497504353621240", "1496756173696058", "1496417457063263", "1496363847068624", "1495736267131382", "1494433783928297", "1494105387294470", "1493605897344419", "1493420930696249", "1493187824052893", "1492420160796326", "1491621254209550", "1491194674252208", "1490365584335117", "1490112464360429", "1489998887705120", "1489048184466857", "1488363677868641", "1488234331214909", "1487136107991398", "1486871934684482", "1486857164685959", "1486111774760498", "1479307862107556", "1478137258891283", "1477101455661530", "1476473472390995", "1475959939109015", "1475955182442824", "1473828015988874", "734984390006209", "1473427769362232", "1473420916029584", "1472777736093902", "1470539332984409", "1469588283079514", "1468754343162908", "1468751273163215", "1468750453163297", "1740832129263695", "1465386863499656", "1465384250166584", "1464700040235005", "1464699543568388", "1464217436949932", "10154678887488177", "1460773570627652", "750743935105758", "750768128436672", "1457914770913532", "1457640604274282", "1457592804279062", "1456746221030387", "1456508761054133", "1455558164482526", "1453164418055234", "1453077724730570", "1451479601557049", "1449253811779628", "1449249091780100", "1449241385114204", "1432381930133483", "1428907037147639", "1428118077226535", "1422718781099798", "1422718664433143", "1421475544557455", "1418710844833925", "1418217028216640", "1417097384995271", "1412968552074821", "1412966105408399", "1412964125408597", "1412961285408881", "1411280675576942", "106601993043002", "188772084825992", "1399454133426263", "734984390006209", "1394096627295347", "1392882994083377", "1392303450807998", "1392033660834977", "1391461887558821", "1390485784323098", "1389048921133451", "2166330973592825", "1388978721140471", "1920215901548129", "1384856251552718", "1384787334892943", "1320257321399241", "1374785195893157", "1374784919226518", "1374783079226702", "1373710662667277", "1373708872667456", "1370225523015791", "1369322029772807", "1362615490443461", "1109412309204433", "1361291883909155", "1361239250581085", "1913410982226338", "1359778310727179", "1359604410744569", "1356548301050180", "384442701937600", "1353858964652447", "1285898314835142", "1353105514727792", "1352710954767248", "1351997098171967", "1350602444978099", "1349942085044135", "1349657988405878", "1349420625096281", "1347246198647057", "1346383895399954", "1344544248917252", "1344081068963570", "1343699165668427", "1343698705668473", "1343697885668555", "1903971853170251", "1335804946457849", "1335369459834731", "1334541326584211", "1334404043264606", "1334060999965577", "1239215529450125", "1236011689770509", "1082369581836532", "1230625093642502", "1329789280386818", "1228996343805377", "320508958305721", "1224781400893538", "1223867680984910", "1223720264332985", "1223709851000693", "1221017594603252", "1218001758238169", "1139777212780587", "1127378354015341", "1209671415737870", "691809194316835", "1202885436416468", "1202174599820885", "1201606389877706", "1200986999939645", "1200634769974868", "1199028746802137", "1198935783478100", "1198904843481194", "1198795830158762", "1198277560210589", "1088938904560119", "1197912573580421", "480811821960519", "1197160403655638", "1197060196998992", "1196265200411825", "946684482142437", "1196176790420666", "1195321770506168", "606325622875523", "1195112603860418", "1195052593866419", "1195050837199928", "1194599863911692", "1194554817249530", "1194351263936552", "1194108657294146", "1194102973961381", "1193738183997860", "1192810617423950", "1192791310759214", "1192676660770679", "1547254242246371", "1191926667512345", "1209529292436546", "1190432707661741", "1189045641133781", "679584485539306", "1181568131881532", "403119539811793", "1175548292503060", "1177393988965613", "1176433969061615", "1176006799104332", "1267867843258392", "1174485799256432", "1173850665986612", "1173554452682900", "1173484839356528", "1173382309366781", "1173381796033499", "1172459289459083", "1171828736188805", "1171334599571552", "1171254666246212", "1170506779654334", "1170279656343713", "1169172043121141", "1169094153128930", "1168608429844169", "1161372910567721", "677637252389226", "1158883060816706", "1158726350832377", "629642147062575", "1085512308207078", "1083735528384756", "1155021574536188", "674314936054791", "1752390331668966", "1153827997988879", "1153595148012164", "1153005614737784", "1152143801490632", "672516782901273", "1150923628279316", "1150919151613097", "1150108285027517", "1149766618395017", "1149539498417729", "1149418545096491", "1149409388430740", "1148697088501970", "1146824248689254", "1146315572073455", "1146015082103504", "1144674348904244", "1144506602254352", "1144032252301787", "1143945802310432", "1141881089183570", "1141567115881634", "1141011965937149", "1140215752683437", "1139728819398797", "880802598733014", "664789363674015", "1138513752853637", "1138426056195740", "1065079440250365", "664374227048862", "1138236709548008", "563721423816161", "1137862002918812", "1137703976267948", "1136420876396258", "1136417759729903", "1136402626398083", "1136338569737822", "1161297447226282", "1133645880007091", "163678327371266", "1132664976771848", "1132650936773252", "1132623400109339", "660340370785581", "1131977146840631", "1131935593511453", "1131662486872097", "1131375620234117", "1131372990234380", "1131020506936295", "1130908536947492", "1130265270345152", "1129989223706090", "519496011578982", "1129500563754956", "1129075040464175", "1128759447162401", "1128693887168957", "1128030123902000", "1127432760628403", "656714267814858", "1126808904024122", "1126471420724537", "1126388944066118", "655594494593502", "1124381687600177", "1124110574293955", "1123919397646406", "654563431363275", "1123486964356316", "1122258807812465", "1122148104490202", "1121922891179390", "1121277954577217", "1121012937937052", "1120874621284217", "1120655751306104", "1120629844642028", "1046088865482756", "1119382811433398", "651464008339884", "1118796194825393", "1118792991492380", "1118712044833808", "1118635561508123", "1118634801508199", "1118630508175295", "1118611801510499", "1118369524868060", "1100963593310796", "796924243741586", "302531913421447", "1769401943342000", "1117383958299950", "1117321998306146", "1117320641639615", "1117027745002238", "649985028487782", "1116947981676881", "1116917545013258", "1116088741762805", "1116082328430113", "1116019978436348", "484346635084870", "1324422697567920", "1115198238518522", "1115191345185878", "1293245480703076", "1114360398602306", "1114198621951817", "1114189185286094", "1114160485288964", "1114140185290994", "1113840891987590", "1113580415346971", "1113579142013765", "1112948732076806", "1112708882100791", "1112566202115059", "1112560642115615", "1685793945015389", "1111784862193193", "1111782712193408", "1111781995526813", "1111772495527763", "1111294435575569", "1111059828932363", "1111057855599227", "1111045832267096", "1110841842287495", "1623012277986806", "1279348465426111", "1109903625714650", "1109902885714724", "1109897109048635", "1109592119079134", "1109558859082460", "1109494322422247", "1109471112424568", "1109382079100138", "1109365455768467", "1109296902441989", "1108900452481634", "1136420839753484", "1108566339181712", "1108231522548527", "643863195766632", "1720348708223211", "1107741285930884", "1107741105930902", "1107740899264256", "1107715725933440", "1107696639268682", "1107659959272350", "1106969189341427", "1106722906032722", "1106675399370806", "1106648879373458", "1106646966040316", "1106646299373716", "1106302632741416", "1106298872741792", "1106293112742368", "1106292089409137", "1106275579410788", "1694319324165473", "1106223496082663", "1106209562750723", "1106075446097468", "1105672969471049", "1105672849471061", "1105660446138968", "1105408866164126", "1104961419542204", "1104932792878400", "1104719992899680", "1104450802926599", "1096538737081361", "1104189622952717", "1104112392960440", "1104097462961933", "1104095359628810", "1103874232984256", "1103840009654345", "1103565626348450", "1103472563024423", "1812682855618237", "1102897286415284", "1102897229748623", "1102540269784319", "629269697221496", "1729658897306432", "1101745183197161", "1101694943202185", "1101694226535590", "1101022226602790", "1100921026612910", "1100211853350494", "1099996143372065", "1099660483405631", "1099067810131565", "1099067693464910", "1646704422284258", "1098642966840716", "1098612273510452", "1098508633520816", "1098470063524673", "1097993193572360", "1097969786908034", "1097969016908111", "1097495056955507", "1688941914703214", "1096872640351082", "1096830130355333", "1096317170406629", "1096201300418216", "1096140873757592", "1095810207123992", "1095806210457725", "1095717117133301", "1094936537211359", "1321698314510580", "1094303697274643", "827901700648518", "1085920191469873", "634628923356726", "1093958807309132", "1093906257314387", "1093204507384562", "1093202190718127", "1093201864051493", "1093151817389831", "1093150270723319", "1092902337414779", "634032270083058", "1092612994110380", "1092513637453649", "1092474500790896", "1092458527459160", "1092247784146901", "1084081721663069", "1091407810897565", "1091406117564401", "1091403717564641", "1091179850920361", "1091138760924470", "1090900330948313", "1090597374311942", "1090576604314019", "1089931384378541", "594293094061664", "1089095887795424", "1089092067795806", "1088600901178256", "1088563364515343", "1088562521182094", "1088389764532703", "1087828724588807", "1087828544588825", "1087798357925177", "1087722944599385", "1087720994599580", "1087446741293672", "1086873391351007", "1086871904684489", "1086871714684508", "1086615331376813", "1086582391380107", "1086286304743049", "1086283654743314", "1085699878135025", "1011348112290165", "1085672511471095", "1085672398137773", "1085672344804445", "1085198871518459", "1085198788185134", "1085155531522793", "1085135871524759", "1085128804858799", "1085117491526597", "1085116988193314", "1085116914859988", "1082570211781325", "1706682296238696", "1081883518516661", "1080916805279999", "1080916735280006", "1080916315280048", "1080915861946760", "1080240252014321", "1078888425482837", "1078226812215665", "1078056885565991", "1077514655620214", "1075655615806118", "1075641875807492", "1074213219283691", "1072650532773293", "1071110072927339", "1070698849635128", "1070698459635167", "1069986119706401", "1068015196570160", "1067196719985341", "1067130386658641", "1067129933325353", "1066563073382039", "1066003916771288", "1065183840186629", "1064719200233093", "1064703900234623", "1064703276901352", "1064703086901371", "1063556090349404", "1063554500349563", "1063549740350039", "1063514083686938", "1063507273687619", "1063367027034977", "10153493399916961", "1062576563780690", "1062575177114162", "1062349710470042", "1062298143808532", "1062239220481091", "1061420760562937", "1061391670565846", "1060882893950057", "1060823210622692", "1060770407294639", "1060465457325134", "1060443320660681", "1060437573994589", "1059922987379381", "1059922080712805", "1059823447389335", "1059560330748980", "1058986904139656", "1058885384149808", "743730619095671", "1058216554216691", "1058206937550986", "1057910764247270", "1134357473264127", "1057319114306435", "1057308227640857", "1057287730976240", "1056847251020288", "1056833147688365", "563378120504464", "1056820037689676", "1056818371023176", "1056814484356898", "1056814167690263", "1056808291024184", "1056807524357594"];

function sleep(ms) {
    return new Promise(resolve => setTimeout(resolve, ms));
}

function forceDownload(blob, filename) {
	let a = document.createElement('a');
	a.download = filename;
	a.href = blob;
	document.body.appendChild(a);
	a.click();
	a.remove();
}

async function downloadResource(url, filename) {
	try {
		let response = await fetch(url, {
			headers: new Headers({
				'Origin': location.origin
			}),
			mode: 'cors',
			redirect: 'follow',
		});
		let blob = await response.blob();
		let blobUrl = window.URL.createObjectURL(blob);
		forceDownload(blobUrl, filename);
		URL.revokeObjectURL(blobUrl);
	} catch (err) {
		
		alert(err);
	}
}

async function store(key, value) {
	let o = {};
	o[key] = value;
	return browser.storage.local.set(o);
}

async function load(key) {
	let o = await browser.storage.local.get(key);
	return o[key];
}

const PHOTO_URL = "https://www.facebook.com/photo.php/?fbid=";
const FULL_SIZE_URL = "https://mbasic.facebook.com/photo/view_full_size/?fbid=";


(async () => {
	try {
		
		let id = await load(SATUK_SCRAPER_ID_KEY);
		if (!id) {
			id = 0;
		}

		let enabled = await load(SCRAPING_ENABLED_KEY);

		document.addEventListener('keydown', async function (event) {
			if (event.keyCode == 40) { // down arrow
				enabled = !enabled;
				alert("scraping set to " + enabled);
				await store(SCRAPING_ENABLED_KEY, enabled);
				window.location.reload(false)
			}
		});

		if (enabled) {
			console.log("id is " + id);
			if (id < ids.length) {
				if (document.location.href.includes("fbcdn.net")) {
					await downloadResource(document.location.href, ids[id] + ".jpg");
					// id += 1;
					// await store(SATUK_SCRAPER_ID_KEY, id);
					// let timeout = 3000 + Math.random() * 5000;
					// await sleep(timeout);
					// window.location.href = FULL_SIZE_URL + ids[id];
				} else if (document.location.href.includes("mbasic.facebook.com/satuk")) {
					window.location.href = PHOTO_URL + ids[id];
				} else if (document.location.href.includes("www.facebook.com/photo")) {
					let load_timeout = 1500;
					await sleep(load_timeout);
					let image = document.querySelector("img[alt]");
					let canvas = document.querySelector("canvas[style]");
					if (image) {
						let url = image.src;
						console.log(url);
						// await downloadResource(url, ids[id] + ".jpg");
						let w = window.open(url, "_blank");
						let timeout = 2500 + Math.random() * 3000;
						await sleep(timeout);
						w.close();
						id += 1;
						await store(SATUK_SCRAPER_ID_KEY, id);
						window.location.href = PHOTO_URL + ids[id];
					} else if (canvas) {
						id += 1;
						await store(SATUK_SCRAPER_ID_KEY, id);
						window.location.href = PHOTO_URL + ids[id];
					} else {
						alert("no image found");
					}
				}
			}
		} else {
			document.body.style.border = "50px solid green";
		}
	} catch (error) {
		alert(error);
	}

})();